<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/favicon-orgin.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/favicon-orgin.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.ichenfu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism-vsc-dark-plus","dark":"prism-vsc-dark-plus"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="C0reFast记事本">
<meta property="og:url" content="https://www.ichenfu.com/page/6/index.html">
<meta property="og:site_name" content="C0reFast记事本">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="陈孚">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.ichenfu.com/page/6/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C0reFast记事本</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-47062085-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-47062085-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js" defer></script>

  <script src="/js/third-party/analytics/baidu-analytics.js" defer></script>
  <script async src="https://hm.baidu.com/hm.js?50e2a95e85fdbe38e53b7aaba8c6cfe1"></script>







  
  <script src="https://fastly.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="C0reFast记事本" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">C0reFast记事本</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">to inspire confidence in somebody.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">陈孚</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">111</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">249</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/C0reFast" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;C0reFast" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chenfu@ichenfu.com" title="E-Mail → mailto:chenfu@ichenfu.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/c0refast" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;c0refast" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>
<div class="sidebar-inner sidebar-blogroll">
  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title">
      赞助商
    </div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9413546783705149" crossorigin="anonymous"></script>
      <!-- Siderbar广告 -->
    <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-9413546783705149"
      data-ad-slot="7305543550"
      data-ad-format="auto"
      data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
</div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.aikaiyuan.com/" title="https:&#x2F;&#x2F;www.aikaiyuan.com&#x2F;" rel="noopener" target="_blank">爱开源</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://blog.yiranzai.top/" title="https:&#x2F;&#x2F;blog.yiranzai.top&#x2F;" rel="noopener" target="_blank">一冉再</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.cnblogs.com/pikachuworld/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;pikachuworld&#x2F;" rel="noopener" target="_blank">PikachuWorld</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/07/31/libvirt-vm-lifecycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/31/libvirt-vm-lifecycle/" class="post-title-link" itemprop="url">Libvirt domain的几种状态及转换关系</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年7月31日 15:55 15:55:46" itemprop="dateCreated datePublished" datetime="2019-07-31T15:55:46+08:00">2019年7月31日 15:55</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在Libvirt里，一个Domain是一个运行在虚拟机器上的操作系统的实例，它可以指一个运行着的虚拟机，或者用于启动虚拟机的配置。<br>那么，对于一个Domain而言，主要有哪些状态呢？，他们的转换关系是什么？可以参考文档<a target="_blank" rel="noopener" href="https://wiki.libvirt.org/page/VM_lifecycle">VM lifecycle</a>。其中，状态主要包括以下：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/07/31/libvirt-vm-lifecycle/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/07/25/git-shallow-clone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/25/git-shallow-clone/" class="post-title-link" itemprop="url">Git的浅克隆功能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年7月25日 8:58 8:58:57" itemprop="dateCreated datePublished" datetime="2019-07-25T08:58:57+08:00">2019年7月25日 8:58</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%88%E7%8E%87%E9%85%8D%E7%BD%AE/" itemprop="url" rel="index"><span itemprop="name">效率配置</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>随着Git仓库不断的被修改，整个仓库会变得越来越大，其中最主要的原因是历史提交特别的多，这个对于想立即阅读最新代码或者CI&#x2F;CD场景下不是特别友好。</p>
<p>面对这种场景，可以利用git提供的浅克隆功能，只clone少部分历史到本地，这样可以极大的减少clone的仓库大小，以PHP源代码代码为例：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/07/25/git-shallow-clone/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/07/18/linux-rlimits/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/18/linux-rlimits/" class="post-title-link" itemprop="url">Linux下的resource limits(ulimit)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年7月18日 9:45 9:45:16" itemprop="dateCreated datePublished" datetime="2019-07-18T09:45:16+08:00">2019年7月18日 9:45</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在Linux下，可以对进程使用的资源做一些限制，比如，可以使用的内存、可以使用的线程、最大能打开的文件数等等，这些也就是我们常说的<code>rlimit</code>，在bash里，可以非常方便的用<code>ulimit</code>这个内置的命令查看和修改这些限制，那么到底这些限制有那些，是怎么来的呢？</p>
<p>首先，在C编程环境下，系统提供了三个接口：<code>int getrlimit(int resource, struct rlimit *rlim);</code>、<code>int setrlimit(int resource, const struct rlimit *rlim);</code>、<code>int prlimit(pid_t pid, int resource, const struct rlimit *new_limit, struct rlimit *old_limit);</code>分别用来获取当前进程的限制、设置当前进程的限制以及根据Pid设置对应进程的限制。</p>
<p>那么具体有哪些限制，也就是接口中的<code>resource</code>参数有哪些，可以参考man里的信息，这里大致翻译一下：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/07/18/linux-rlimits/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/05/22/merge-commits-with-git-rebase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/22/merge-commits-with-git-rebase/" class="post-title-link" itemprop="url">利用Git的Rebase功能合并一系列commits</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年5月22日 17:24 17:24:13" itemprop="dateCreated datePublished" datetime="2019-05-22T17:24:13+08:00">2019年5月22日 17:24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%88%E7%8E%87%E9%85%8D%E7%BD%AE/" itemprop="url" rel="index"><span itemprop="name">效率配置</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>工作中如果使用Git作为版本管理工具的话，应该经常会遇到因为各种原因一下提交了很多个commit的情况，比如添加一个功能，测试出问题继续commit修改，最后<code>git log</code>看提交历史就会变成这样：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># git log</span>
commit 9995aafb7a597d9a7fcf9a341a731324813c5aad <span class="token punctuation">(</span>HEAD -<span class="token operator">></span> master<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
    Commit <span class="token number">4</span>

commit 54062e7317fa19a228d8f4f63236467317c17672
<span class="token punctuation">..</span>.
    Commit <span class="token number">3</span>

commit 1571ee6b861315ec46875fbececd46c9daaa5d04
<span class="token punctuation">..</span>.
    Commit <span class="token number">2</span>

commit ae95aac116af934742e1dd2eca435a0d6e70b77f
<span class="token punctuation">..</span>.
    Commit <span class="token number">1</span>

commit 3f0373c3afb9e9ffd6174b8244ec3e936d3583e0
<span class="token punctuation">..</span>.
    init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样看起来不那么美观，也会一定程度上污染主分支，如果遇到问题，需要看diff的时候，也会不那么方便，所以介绍一个利用<code>git rebase</code>命令合并一系列commit的方法。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/05/22/merge-commits-with-git-rebase/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/04/09/istio-inbond-interception-and-linux-transparent-proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/09/istio-inbond-interception-and-linux-transparent-proxy/" class="post-title-link" itemprop="url">Istio的流量劫持和Linux下透明代理实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年4月9日 9:13 9:13:49" itemprop="dateCreated datePublished" datetime="2019-04-09T09:13:49+08:00">2019年4月9日 9:13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一般情况下，如果一个程序需要使用代理服务器，那么需要在运行的时候设置一下参数，或者，在Linux下，大部分的程序支持<code>http_proxy</code>这个环境变量，设置这个环境变量，意味着程序将使用设置值作为代理。<br>这样的问题在于，设置代理这个操作是不透明的，也就是说，客户端必须要知道代理的存在，需要手动设置将流量导入到代理，如果程序本身不支持代理，或者我们不希望执行所有程序的时候都手动设置代理，那么就需要一个相对“透明”的代理办法了。</p>
<p>同样的，作为ServiceMesh界的当红实现Istio，也会遇到类似的问题，如何在程序完全没有感知的情况下悄无声息的将程序的流量劫持到自己的代理呢？</p>
<p>借助Istio的两种实现方式，也说一下目前Liunx下两种透明代理的实现。</p>
<h2 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h2><p>首先是使用iptables的<code>REDIRECT</code>模式，通过iptables，可以将所有的流量都重定向到一个特定的端口上，如果配置过<code>ss-redir</code>的话，应该会对这种实现非常的熟悉，具体的，在iptables里对应一条规则：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> REDIRECT --to-port <span class="token number">5000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>即将所有流量都重定向到<code>5000</code>端口，仔细看一下，是不是和iptables实现DNAT有点相似？没错！本质上<code>REDIRECT</code>就是一个特殊的DNAT规则，一般情况下，我们利用iptables做DNAT的时候，需要指定目标的IP和端口，这样iptables才能知道需要将数据包的目的修改成什么，而<code>REDIRECT</code>模式下，只需要指定端口就可以，iptables会自动帮我们判断需要设置的IP地址。</p>
<p>继续思考，会发现另一个问题，那就是，既然是做了DNAT，也就意味着数据包里已经没有原始的目的地址了，那数据包到了代理程序，代理程序是如何知道这个数据包应该往什么地方发送呢？这个是个非常核心的问题，因为如果不知道原始的目的IP端口信息，代理完全不能起作用啊！</p>
<p>当然问题是有办法的，<code>conntrack</code>在这时候起作用了，<code>conntrack</code>会记录原始的地址，而在用户侧，内核提供了一个接口，可以让应用程序获取到原始的IP端口，可以参考一下<code>ss-redir</code>的实现：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">getdestaddr</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> <span class="token operator">*</span>destaddr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">socklen_t</span> socklen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>destaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> error         <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    error <span class="token operator">=</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_IPV6<span class="token punctuation">,</span> IP6T_SO_ORIGINAL_DST<span class="token punctuation">,</span> destaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>socklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Didn't find a proper way to detect IP version.</span>
        error <span class="token operator">=</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SOL_IP<span class="token punctuation">,</span> SO_ORIGINAL_DST<span class="token punctuation">,</span> destaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>socklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用<code>getsockopt</code>的<code>SO_ORIGINAL_DST</code>参数，可以获取到原始的连接IP和端口，好了，目前代理所需要的所有的信息都完整了，整个代理理论上就可以工作了，剩下的就是代理如何实现的问题了，这里就不探讨了。</p>
<h2 id="TPROXY"><a href="#TPROXY" class="headerlink" title="TPROXY"></a>TPROXY</h2><p>除了利用<code>REDIRECT</code>模式，Istio还提供<code>TPROXY</code>模式，当然也是借助Linux内核提供的功能实现的，对于<code>TPROXY</code>模式，实现的原理要相对复杂不少，需要借助iptables和路由：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-j</span> TPROXY --tproxy-mark 0x1/0x1 --on-port <span class="token number">8888</span>
<span class="token function">ip</span> rule <span class="token function">add</span> fwmark 0x1/0x1 pref <span class="token number">100</span> table <span class="token number">100</span>
<span class="token function">ip</span> route <span class="token function">add</span> <span class="token builtin class-name">local</span> default dev lo table <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通过iptables将数据包打上mark，然后使用一个特殊的路由，将数据包指向本地，由于使用了mangle表，所以数据包的原始和目的地址都是不会被修改的。</p>
<p>那么问题来了，应用程序怎么编写？假如需要连接<code>1.2.3.4:80</code>这个端口，就算数据包到了本地，但是本地并没有<code>1.2.3.4</code>这个IP地址啊，程序是怎么能拿到数据的？不是应该直接丢弃这个数据包么？<br>针对这个问题，可以看一个例子<a target="_blank" rel="noopener" href="https://github.com/kristrev/tproxy-example">tproxy-example</a>，这个例子实现了一个简单的基于TPROXY的代理。</p>
<p>针对上面的情况，Linux提供了一个选项<code>IP_TRANSPARENT</code>，这个选项很神奇，可以让程序bind一个不属于本机的地址，作为客户端，它可以使用一个不属于本机地址的IP地址作为源IP发起连接，作为服务端，它可以侦听在一个不属于本机的IP地址上，而这正是透明代理所必须的。我们看下例子程序里的代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>res<span class="token operator">-></span>ai_family<span class="token punctuation">,</span> res<span class="token operator">-></span>ai_socktype<span class="token punctuation">,</span>
                res<span class="token operator">-></span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt (SO_REUSEADDR): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//Mark that this socket can be used for transparent proxying</span>
<span class="token comment">//This allows the socket to accept connections for non-local IPs</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> SOL_IP<span class="token punctuation">,</span> IP_TRANSPARENT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>yes<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt (IP_TRANSPARENT): "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> res<span class="token operator">-></span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-></span>ai_addrlen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也确实是设置了<code>IP_TRANSPARENT</code>，有了这个选项，也就意味着代理绑定了所有的IP，当然<code>1.2.3.4</code>这个IP也在范围内，所以可以正常的接受连接。<br>而由于<code>TPROXY</code>模式并没有改变数据包，所以直接通过<code>getsockname</code>获取到原始的IP端口信息：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;Store the original destination address in remote_addr
&#x2F;&#x2F;Return 0 on success, &lt;0 on failure
static int get_org_dstaddr(int sockfd, struct sockaddr_storage *orig_dst)&#123;
    char orig_dst_str[INET6_ADDRSTRLEN];
    socklen_t addrlen &#x3D; sizeof(*orig_dst);

    memset(orig_dst, 0, addrlen);

    &#x2F;&#x2F;For UDP transparent proxying:
    &#x2F;&#x2F;Set IP_RECVORIGDSTADDR socket option for getting the original
    &#x2F;&#x2F;destination of a datagram

    &#x2F;&#x2F;Socket is bound to original destination
    if(getsockname(sockfd, (struct sockaddr*) orig_dst, &amp;addrlen)
            &lt; 0)&#123;
        perror(&quot;getsockname: &quot;);
        return -1;
    &#125; else &#123;
        if(orig_dst-&gt;ss_family &#x3D;&#x3D; AF_INET)&#123;
            inet_ntop(AF_INET,
                    &amp;(((struct sockaddr_in*) orig_dst)-&gt;sin_addr),
                    orig_dst_str, INET_ADDRSTRLEN);
            fprintf(stderr, &quot;Original destination %s\n&quot;, orig_dst_str);
        &#125; else if(orig_dst-&gt;ss_family &#x3D;&#x3D; AF_INET6)&#123;
            inet_ntop(AF_INET6,
                    &amp;(((struct sockaddr_in6*) orig_dst)-&gt;sin6_addr),
                    orig_dst_str, INET6_ADDRSTRLEN);
            fprintf(stderr, &quot;Original destination %s\n&quot;, orig_dst_str);
        &#125;

        return 0;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面就是两种Linux下实现透明代理的方式，透过现象看本质，无论实现方式是什么，其实都定位到一个核心问题，即在没有代理的情况下，连接的五元组是什么？数据包最核心的源地址源端口，目的地址目的端口，无论是通过NAT方式修改数据包重定向，或者借助内核的一些特殊特性，都必须要知道这4个关键信息，一旦搞清楚这些，那理论上代理就能工作了，剩下的就是如何将代理本身做好，那就是一个业务逻辑的问题了。</p>
<p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://serverfault.com/questions/179200/difference-beetween-dnat-and-redirect-in-iptables">https://serverfault.com/questions/179200/difference-beetween-dnat-and-redirect-in-iptables</a></li>
<li><a target="_blank" rel="noopener" href="https://vvl.me/2018/06/09/from-ss-redir-to-linux-nat/">https://vvl.me/2018/06/09/from-ss-redir-to-linux-nat/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/dog250/article/details/13161945">https://blog.csdn.net/dog250/article/details/13161945</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/networking/tproxy.txt">https://www.kernel.org/doc/Documentation/networking/tproxy.txt</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/03/14/proxy-arp-in-calico/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/14/proxy-arp-in-calico/" class="post-title-link" itemprop="url">Calico网络中的ProxyARP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年3月14日 10:43 10:43:33" itemprop="dateCreated datePublished" datetime="2019-03-14T10:43:33+08:00">2019年3月14日 10:43</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如果K8s使用Calico作为网络方案的话，应该都会知道Calico是个纯3层的方案，也是就说，所有的数据包，都是通过路由的形式找到对应机器和容器的，然后通过BGP协议来将所有的路由同步到所有的机器或者数据中心，来完成整个网络的互联。<br>简单的来说，Calico针对一个容器，在主机上创建了一堆veth pair，其中一端在主机，一端在容器的网络空间里，然后在主机和容器中分别设置几条路由，来完成网络的互联，我们可以看一个例子：</p>
<p>主机上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> addr
<span class="token punctuation">..</span>.
<span class="token number">771</span>: cali45b9132fec1@if4: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1440</span> qdisc noqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">14</span>
    inet6 fe80::ecee:eeff:feee:eeee/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever
<span class="token punctuation">..</span>.

$ <span class="token function">ip</span> route 
<span class="token punctuation">..</span>.
<span class="token number">10.218</span>.240.252 dev cali45b9132fec1 scope <span class="token function">link</span>
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>容器里：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: eth0@if771: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN<span class="token operator">></span> mtu <span class="token number">1440</span> qdisc noqueue state UP
    link/ether <span class="token number">66</span>:fb:34:db:c9:b4 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.218</span>.240.252/32 scope global eth0
       valid_lft forever preferred_lft forever

$ <span class="token function">ip</span> route
default via <span class="token number">169.254</span>.1.1 dev eth0
<span class="token number">169.254</span>.1.1 dev eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>按照上面的逻辑，可以理一下：</p>
<ul>
<li>当目的地址是<code>10.218.240.252</code>的数据包，也就是目的是容器的数据包，到达主机，主机根据<code>10.218.240.252 dev cali45b9132fec1 scope link</code>这条路由，将数据包丢给<code>cali45b9132fec1</code>这个veth<br>，然后容器中对应的<code>eth0</code>就可以收到数据包了。</li>
<li>当容器中的数据包需要发出，就是走默认路由，也就是<code>default via 169.254.1.1 dev eth0</code>，将数据包丢给<code>eth0</code>，这时主机对应的<code>cali45b9132fec1</code>可以收到包，然后继续进行路由选择，转发到对应端口。</li>
</ul>
<p>这么一看好像没什么问题，但是总觉得不对，为什么容器里的默认网关是<code>169.254.1.1</code>呢？二层是怎么处理的？</p>
<p>我们重新思考一下数据包的传输：<br>当一个数据包的目的地址不是本机，所以需要查询路由表，当查到路由表中的网关之后，需要获取网关的MAC地址，并将数据包的MAC地址修改成网关地址，然后发送到对应的网卡。</p>
<p>问题来了。在容器里的网关是<code>169.254.1.1</code>，那网关的MAC地址是什么？<br>正常情况下，内核会对外发送ARP请求，去询问整个二层网络中谁拥有<code>169.254.1.1</code>这个IP地址，拥有这个IP地址的设备会将自己的MAC返回。<br>但是现在的情况是，对于容器和主机，都没有<code>169.254.1.1</code>这个IP，甚至，在主机上的端口<code>cali45b9132fec1</code>，MAC地址也是一个无用的<code>ee:ee:ee:ee:ee:ee</code>。所以，如果仅仅是目前的状况，容器和主机网络根本就无法通信！<br>所以Calico是怎么做到的呢？在Calico的<a target="_blank" rel="noopener" href="https://docs.projectcalico.org/v3.5/usage/troubleshooting/faq">FAQ</a>里，官方给了答案：</p>
<blockquote><h3 id="Why-can’t-I-see-the-169-254-1-1-address-mentioned-above-on-my-host"><a href="#Why-can’t-I-see-the-169-254-1-1-address-mentioned-above-on-my-host" class="headerlink" title="Why can’t I see the 169.254.1.1 address mentioned above on my host?"></a>Why can’t I see the 169.254.1.1 address mentioned above on my host?</h3><p>Calico tries hard to avoid interfering with any other configuration on the host. Rather than adding the gateway address to the host side of each workload interface, Calico sets the proxy_arp flag on the interface. This makes the host behave like a gateway, responding to ARPs for 169.254.1.1 without having to actually allocate the IP address to the interface.</p>
</blockquote>

<p>Calico利用了网卡的<code>proxy_arp</code>功能，具体的，是将<code>/proc/sys/net/ipv4/conf/DEV/proxy_arp</code>置为1，当设置这个标志之后，主机就会看起来像一个网关，会响应所有的ARP请求，并将自己的MAC地址告诉客户端。<br>也就是说，当容器发送ARP请求时，主机会告诉容器，我拥有<code>169.254.1.1</code>这个IP，我的MAC地址是XXX，这样，容器就可以顺利的将数据包发出来了，于是网络就通了。</p>
<p>其实Calico不仅仅设置了这个标志，但是这个标志是最重要的，毕竟关系到网络是否能通的问题。看了看Cailco的代码，发现Calico还设置了其他几个标志位：</p>
<ul>
<li><code>/proc/sys/net/ipv4/conf/DEV/rp_filter</code> &#x3D;&gt; 1：开启反向路径过滤，确认数据包来源，对于普通容器，IP基本无法伪装，但是如果是VM（Calico也支持VM），很容易伪装IP地址，所以为了安全打开这个选项。</li>
<li><code>/proc/sys/net/ipv4/conf/DEV/route_localnet</code> &#x3D;&gt; 1：允许路由到本地。</li>
<li><code>/proc/sys/net/ipv4/neigh/DEV/proxy_delay</code> &#x3D;&gt; 0：默认情况下，主机为了减少ARP风暴的可能，会延迟一段时间回复ARP包，这个选项关闭这个延迟。</li>
<li><code>/proc/sys/net/ipv4/conf/DEV/forwarding</code> &#x3D;&gt; 1：允许转发数据包（如果不允许转发的话，那数据包就出不去主机了）。</li>
</ul>
<p>上面是IPv4的情况，如果是IPv6的网络，则会设置：</p>
<ul>
<li><code>/proc/sys/net/ipv6/conf/DEV/proxy_ndp</code> &#x3D;&gt; 1：这个和<code>proxy_arp</code>是一样的。</li>
<li><code>/proc/sys/net/ipv4/conf/DEV/forwarding</code> &#x3D;&gt; 1：同IPv4。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/03/10/how-to-drop-10-million-packets-per-second/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/10/how-to-drop-10-million-packets-per-second/" class="post-title-link" itemprop="url">如何在一秒之内丢弃1000万个网络数据包？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年3月10日 11:45 11:45:53" itemprop="dateCreated datePublished" datetime="2019-03-10T11:45:53+08:00">2019年3月10日 11:45</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-Kernel/" itemprop="url" rel="index"><span itemprop="name">Linux Kernel</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>偶然看到一篇cloudflare的博客<a target="_blank" rel="noopener" href="https://blog.cloudflare.com/how-to-drop-10-million-packets/">How to drop 10 million packets per second</a>，如何实现单核情况下一秒钟丢弃1000万个数据包，原文循序渐进，从最简单的用户态丢弃到使用非常新的技术XDP，逐步将单核丢包性能提升到10mpps，很有意思，网上也没有看到原文的中文版本，所以这里顺便翻译一下，看看cloudflare是如何处理类似的情况的。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/03/10/how-to-drop-10-million-packets-per-second/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/02/20/kubernetes-namespaces-stuck-in-terminating-state/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/20/kubernetes-namespaces-stuck-in-terminating-state/" class="post-title-link" itemprop="url">删除K8s Namespace时卡在Terminating状态</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年2月20日 18:04 18:04:18" itemprop="dateCreated datePublished" datetime="2019-02-20T18:04:18+08:00">2019年2月20日 18:04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>想要删除K8s里的一个Namespace，结果删除了所有该Namespace资源之后使用<code>kubectl delete namespace test</code>发现删除不掉，一直卡在<code>Terminating</code>状态，使用<code>--force</code>参数依然无法删除，报错:<br><code>Error from server (Conflict): Operation cannot be fulfilled on namespaces &quot;test&quot;: The system is ensuring all content is removed from this namespace.  Upon completion, this namespace will automatically be purged by the system.</code><br>找了一圈，发现<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/19317">这个Issue</a>，里面<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/19317#issuecomment-457745457">有条评论</a></p>
<blockquote><p>kubectl get namespace annoying-namespace-to-delete -o json &gt; tmp.json<br>then edit tmp.json and remove”kubernetes”</p>
<p>curl -k -H “Content-Type: application&#x2F;json” -X PUT –data-binary @tmp.json <a target="_blank" rel="noopener" href="https://kubernetes-cluster-ip/api/v1/namespaces/annoying-namespace-to-delete/finalize">https://kubernetes-cluster-ip/api/v1/namespaces/annoying-namespace-to-delete/finalize</a></p>
<p>and it should delete your namespace,</p>
</blockquote>

<p>跟着试了一下，很管用，直接就删除了：<br>先运行<code>kubectl get namespace test -o json &gt; tmp.json</code>，拿到当前namespace描述，然后打开<code>tmp.json</code>，删除其中的<code>spec</code>字段。因为这边的K8s集群是带认证的，所以又新开了窗口运行<code>kubectl proxy</code>跑一个API代理在本地的8081端口。最后运行<code>curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/test/finalize</code></p>
<p>搞定！</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/02/20/kubernetes-namespaces-stuck-in-terminating-state/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2019/02/11/kubelet-boot-id/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/11/kubelet-boot-id/" class="post-title-link" itemprop="url">kubelet判断机器是否重启逻辑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019年2月11日 11:09 11:09:15" itemprop="dateCreated datePublished" datetime="2019-02-11T11:09:15+08:00">2019年2月11日 11:09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如果K8s中某个Node节点重启，在Event信息中会有一条消息，大致内容如<code>Node xxxxx has been rebooted, boot id: xxx</code>，而如果是重启<code>kubelet</code>，则不会有这条消息，所以<code>kubelet</code>是怎么判断是自己重启了还是机器重启了呢？</p>
<p>搜索了一下代码，在<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/v1.10.12/pkg/kubelet/kubelet_node_status.go#L621">https://github.com/kubernetes/kubernetes/blob/v1.10.12/pkg/kubelet/kubelet_node_status.go#L621</a>这里，会判断上次记录的Node的BootID和当前从cAdvisor获取的BootID是否相同，如果不同则说明机器重启了。</p>
<p>那么<code>cAdvisor</code>是怎么获得这个BootID的呢？看了一下<code>cAdvisor</code>的文档，发现默认是从<code>/proc/sys/kernel/random/boot_id</code>这个文件读取的。针对这个文件，找到一段解析：</p>
<blockquote><p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id: A random ID that is regenerated on each boot. As such it can be used to identify the local machine’s current boot. It’s universally available on any recent Linux kernel. It’s a good and safe choice if you need to identify a specific boot on a specific booted kernel.</p>
</blockquote>
<p>是内核暴露的一个接口，每次启动都会随机生成一个ID，是一个比较通用和安全的判断启动的办法。</p>
<p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://0pointer.de/blog/projects/ids.html">http://0pointer.de/blog/projects/ids.html</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2018/12/24/centos-bonding-vlan-bridge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/24/centos-bonding-vlan-bridge/" class="post-title-link" itemprop="url">CentOS系统Bonding+VLAN+Bridge配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018年12月24日 9:35 9:35:52" itemprop="dateCreated datePublished" datetime="2018-12-24T09:35:52+08:00">2018年12月24日 9:35</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">Linux部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由于业务的需要，需要在我们的一台虚拟化机器上，实现如下的配置：</p>
<p>首先，需要将两块网卡设置Bonding并配置交换机对应端口trunk模式;在此基础上，添加宿主机的IP地址，并添加相应的VLAN，最后，还需要添加一个Bridge，用于桥接创建的虚拟机。</p>
<p>由于本身这台机器就是Openstack的宿主机，所以当前的状况是除了所需要的一个Bridge，其他都已经配置完成了，并且由于Openstack的原因，已经有个Bridge virbr0被绑定到bond0上了。<br>但是呢，这个Bridge是给ovs用的，也就是说，桥接在virbr0上的网络需要自己带上VLAN的tag才能正常工作，而我们希望的是再有一个Bridge br0，桥接在br0上不需要管理VLAN，保持和宿主机相同就可以。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/12/24/centos-bonding-vlan-bridge/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">陈孚</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"C0reFast/c0refast.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
