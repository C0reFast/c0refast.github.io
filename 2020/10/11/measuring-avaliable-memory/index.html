<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/favicon-orgin.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/favicon-orgin.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.ichenfu.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="事情的起因呢，是我们收到了一条内存报警，提示某台机器的可用内存不足，可用内存剩下不到14G。原本只是一个很简单的问题，但是呢，这次却发现了一些不一样的点。登录机器后，free -m命令执行的结果如下： ]# free -m               total        used        free      shared  buff&#x2F;cache   available Mem:">
<meta property="og:type" content="article">
<meta property="og:title" content="当我们在讨论可用内存，我们在讨论什么？">
<meta property="og:url" content="https://www.ichenfu.com/2020/10/11/measuring-avaliable-memory/index.html">
<meta property="og:site_name" content="C0reFast记事本">
<meta property="og:description" content="事情的起因呢，是我们收到了一条内存报警，提示某台机器的可用内存不足，可用内存剩下不到14G。原本只是一个很简单的问题，但是呢，这次却发现了一些不一样的点。登录机器后，free -m命令执行的结果如下： ]# free -m               total        used        free      shared  buff&#x2F;cache   available Mem:">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-10-11T11:56:50.000Z">
<meta property="article:modified_time" content="2020-10-19T01:53:07.670Z">
<meta property="article:author" content="陈孚">
<meta property="article:tag" content="meminfo">
<meta property="article:tag" content="SReclaimable">
<meta property="article:tag" content="available memory">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.ichenfu.com/2020/10/11/measuring-avaliable-memory/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.ichenfu.com/2020/10/11/measuring-avaliable-memory/","path":"2020/10/11/measuring-avaliable-memory/","title":"当我们在讨论可用内存，我们在讨论什么？"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>当我们在讨论可用内存，我们在讨论什么？ | C0reFast记事本</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-47062085-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-47062085-1","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?50e2a95e85fdbe38e53b7aaba8c6cfe1"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="C0reFast记事本" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">C0reFast记事本</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">to inspire confidence in somebody.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">陈孚</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">225</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.aikaiyuan.com/" title="https:&#x2F;&#x2F;www.aikaiyuan.com&#x2F;" rel="noopener" target="_blank">爱开源</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://blog.yiranzai.top/" title="https:&#x2F;&#x2F;blog.yiranzai.top&#x2F;" rel="noopener" target="_blank">一冉再</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.cnblogs.com/pikachuworld/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;pikachuworld&#x2F;" rel="noopener" target="_blank">PikachuWorld</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.ichenfu.com/2020/10/11/measuring-avaliable-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈孚">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C0reFast记事本">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="当我们在讨论可用内存，我们在讨论什么？ | C0reFast记事本">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          当我们在讨论可用内存，我们在讨论什么？
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020年10月11日 19:56 19:56:50" itemprop="dateCreated datePublished" datetime="2020-10-11T19:56:50+08:00">2020年10月11日 19:56</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020年10月19日 9:53 9:53:07" itemprop="dateModified" datetime="2020-10-19T09:53:07+08:00">2020年10月19日 9:53</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>事情的起因呢，是我们收到了一条内存报警，提示某台机器的可用内存不足，可用内存剩下不到14G。原本只是一个很简单的问题，但是呢，这次却发现了一些不一样的点。<br>登录机器后，<code>free -m</code>命令执行的结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">]</span><span class="token comment"># free -m</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:         <span class="token number">385445</span>      <span class="token number">363181</span>        <span class="token number">1917</span>           <span class="token number">4</span>       <span class="token number">20346</span>       <span class="token number">21147</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>问题来了，报警里的14G内存，是从哪来的？好像没有一个数字和这个14G接近？</p>
<span id="more"></span>
<p>需要说明的是，我们内部的监控系统，提供了一个计算值<code>freemem</code>来表示机器的可用内存，这个值的计算方法是<code>freemem = $MemFree + $Buffers + $Cached</code>，其中<code>$MemFree</code>、<code>$Buffers</code>和<code>$Cached</code>是在<code>/proc/meminfo</code>中取到的值，看一下这个文件的内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">]</span><span class="token comment"># cat /proc/meminfo</span>
MemTotal:       <span class="token number">394696352</span> kB
MemFree:         <span class="token number">1964616</span> kB
MemAvailable:   <span class="token number">21656108</span> kB
Buffers:          <span class="token number">993900</span> kB
Cached:         <span class="token number">11332776</span> kB
SwapCached:            <span class="token number">0</span> kB
Active:         <span class="token number">370488716</span> kB
Inactive:        <span class="token number">4698796</span> kB
Active<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>:   <span class="token number">362864228</span> kB
Inactive<span class="token punctuation">(</span>anon<span class="token punctuation">)</span>:     <span class="token number">1588</span> kB
Active<span class="token punctuation">(</span>file<span class="token punctuation">)</span>:    <span class="token number">7624488</span> kB
Inactive<span class="token punctuation">(</span>file<span class="token punctuation">)</span>:  <span class="token number">4697208</span> kB
Unevictable:           <span class="token number">0</span> kB
Mlocked:               <span class="token number">0</span> kB
SwapTotal:             <span class="token number">0</span> kB
SwapFree:              <span class="token number">0</span> kB
Dirty:              <span class="token number">1964</span> kB
Writeback:             <span class="token number">0</span> kB
AnonPages:      <span class="token number">362861084</span> kB
Mapped:           <span class="token number">249620</span> kB
Shmem:              <span class="token number">4980</span> kB
Slab:           <span class="token number">10263200</span> kB
SReclaimable:    <span class="token number">8507928</span> kB
SUnreclaim:      <span class="token number">1755272</span> kB
KernelStack:       <span class="token number">38064</span> kB
PageTables:       <span class="token number">740048</span> kB
// 省略<span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么监控计算出来<code>freemem</code>值为：<code>(1964616+993900+11332776)/1024/1024 =&gt; 13.6G</code>，说明报警系统是没有问题的，那为什么这个值和<code>free</code>命令里的值差距很大呢？对比free的输出，发现free内存和meminfo中数字差不多，但是buff&#x2F;cache的和加起来比meminfo里大了不少，难不成多加了其他的内存？话不多说，找找free命令的源码看看吧。简单看了一下源码，找到最终计算这些数字的代码在：<a target="_blank" rel="noopener" href="https://gitlab.com/procps-ng/procps/-/blob/v3.3.16/proc/sysinfo.c#L781">proc&#x2F;sysinfo.c</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">meminfo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 省略...</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> mem_table_struct mem_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Active"</span><span class="token punctuation">,</span>       <span class="token operator">&amp;</span>kb_active<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>       <span class="token comment">// important</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Active(file)"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>kb_active_file<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span><span class="token string">"AnonPages"</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>kb_anon_pages<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Bounce"</span><span class="token punctuation">,</span>       <span class="token operator">&amp;</span>kb_bounce<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Buffers"</span><span class="token punctuation">,</span>      <span class="token operator">&amp;</span>kb_main_buffers<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// important</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Cached"</span><span class="token punctuation">,</span>       <span class="token operator">&amp;</span>kb_page_cache<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// important</span>
  <span class="token comment">// 省略...</span>
  <span class="token punctuation">&#123;</span><span class="token string">"SReclaimable"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>kb_slab_reclaimable<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// "slab reclaimable" (dentry and inode structures)</span>
  <span class="token punctuation">&#123;</span><span class="token string">"SUnreclaim"</span><span class="token punctuation">,</span>   <span class="token operator">&amp;</span>kb_slab_unreclaimable<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Shmem"</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span>kb_main_shared<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">// kernel 2.6.32 and later</span>
  <span class="token punctuation">&#123;</span><span class="token string">"Slab"</span><span class="token punctuation">,</span>         <span class="token operator">&amp;</span>kb_slab<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>         <span class="token comment">// kB version of vmstat nr_slab</span>
  <span class="token punctuation">&#123;</span><span class="token string">"SwapCached"</span><span class="token punctuation">,</span>   <span class="token operator">&amp;</span>kb_swap_cached<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token comment">// 省略...</span>
  kb_main_cached <span class="token operator">=</span> kb_page_cache <span class="token operator">+</span> kb_slab_reclaimable<span class="token punctuation">;</span>
  <span class="token comment">// 省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，free里的cache，是经过计算的，计算方法是<code>$Cached + $SReclaimable</code>，如果按这个计算方法，我们的监控系统里就少加了一个<code>$SReclaimable</code>值，看下meminfo里的这个值<code>SReclaimable:    8507928 kB</code>，大概8.5G，加上之前的13.6G，算下来和free的结果一致了。</p>
<p>再看看<code>SReclaimable</code>代表的是什么呢？<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">内核文档</a>里这样描述:</p>
<blockquote><p>KReclaimable: Kernel allocations that the kernel will attempt to reclaim<br>              under memory pressure. Includes SReclaimable (below), and other<br>              direct allocations with a shrinker.<br>        Slab: in-kernel data structures cache<br>SReclaimable: Part of Slab, that might be reclaimed, such as caches<br>  SUnreclaim: Part of Slab, that cannot be reclaimed on memory pressure</p>
</blockquote>

<p>Slab是内核的小数据cache，然后SReclaimable是这部分数据里可用被回收的，和Cache是一样的逻辑。那被free命令当作是Cache处理确实也没问题。</p>
<p>整个问题到这里，是不是就结束了呢？是不是只要我们的监控系统里计算<code>freemem</code>的时候多加一个SReclaimable的值就行了呢？</p>
<p>回到最初的问题，我们想要是什么？是希望能监控机器得可用资源，所以，这个内存可用资源应该尽可能靠近这台机器实际可以被使用得内存资源。一般情况下，<code>$MemFree + $Buffers + $Cached + $SReclaimable</code>应该是能基本反映机器的可用内存的，毕竟一般情况下通过<code>echo 3 &gt; /proc/sys/vm/drop_caches</code>可用让系统把Buffers，Cached内存释放掉，经过测试，这个操作也会同步把SReclaimable内存也释放了。</p>
<p>但是上面忽略了一点，就是有些内存在执行<code>echo 3 &gt; /proc/sys/vm/drop_caches</code>时是不会释放的。一个典型例子：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">]</span><span class="token comment"># free -m -w</span>
              total        used        <span class="token function">free</span>      shared     buffers       cache   available
Mem:          <span class="token number">32010</span>         <span class="token number">332</span>       <span class="token number">31535</span>           <span class="token number">8</span>           <span class="token number">9</span>         <span class="token number">133</span>       <span class="token number">31374</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span>
<span class="token punctuation">]</span><span class="token comment"># mkdir /tmp/tmpfs</span>
<span class="token punctuation">]</span><span class="token comment"># mount -t tmpfs -o size=16g tmpfs /tmp/tmpfs/</span>
<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/zero of=/tmp/tmpfs/test bs=1G count=15</span>
<span class="token number">15</span>+0 records <span class="token keyword">in</span>
<span class="token number">15</span>+0 records out
<span class="token number">16106127360</span> bytes <span class="token punctuation">(</span><span class="token number">16</span> GB<span class="token punctuation">)</span> copied, <span class="token number">7.56507</span> s, <span class="token number">2.1</span> GB/s
<span class="token punctuation">]</span><span class="token comment"># free -m -w</span>
              total        used        <span class="token function">free</span>      shared     buffers       cache   available
Mem:          <span class="token number">32010</span>         <span class="token number">332</span>       <span class="token number">16124</span>       <span class="token number">15368</span>           <span class="token number">9</span>       <span class="token number">15543</span>       <span class="token number">15988</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span>
<span class="token punctuation">]</span><span class="token comment"># echo 3 > /proc/sys/vm/drop_caches</span>
<span class="token punctuation">]</span><span class="token comment"># free -m -w</span>
              total        used        <span class="token function">free</span>      shared     buffers       cache   available
Mem:          <span class="token number">32010</span>         <span class="token number">329</span>       <span class="token number">16206</span>       <span class="token number">15368</span>           <span class="token number">5</span>       <span class="token number">15468</span>       <span class="token number">16030</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，如果挂载的tmpfs中有数据，那么这个tmpfs实际所占用的空间是被计算在Cached内存里了，但是在drop_caches的时候，这部分内存是不会被释放的。那么，调整一下算法<code>$MemFree + $Buffers + $Cached + $SReclaimable - $Shmem</code>，这样相对之前来说，会更加准确一些。</p>
<p>然而事情还没完，如果注意下free命令的输出：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">]</span><span class="token comment"># free -m</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:         <span class="token number">385445</span>      <span class="token number">363181</span>        <span class="token number">1917</span>           <span class="token number">4</span>       <span class="token number">20346</span>       <span class="token number">21147</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现有个available列，这个列代表什么？看名字好像和我们需要的值很像，这里直接参考man free的说明：</p>
<blockquote><p>available<br>        Estimation of how much memory is available for starting new applications, without swapping. Unlike the data provided by the cache or free fields, this field takes into  account  page  cache<br>        and  also that not all reclaimable memory slabs will be reclaimed due to items being in use (MemAvailable in &#x2F;proc&#x2F;meminfo, available on kernels 3.14, emulated on kernels 2.6.27+, otherwise<br>        the same as free)</p>
</blockquote>

<p>看这个描述，这个字段代表在不进行swap的情况下，新的应用程序能使用的内存数量。这个和我们的需求非常的接近。数字来源在3.14及以上内核里是&#x2F;proc&#x2F;meminfo里的MemAvailable字段，在大于2.6.27的内核里是模拟出来的，其他情况保持和free内存一致。两个问题，内核是怎么计算MemAvailable的？free命令是怎么模拟的？</p>
<p>先看看内核的吧，<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=34e431b0ae398fc54ea69ff85ec700722c9da773">这个Commit</a>引入了这个字段：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">for_each_zone</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span>
	wmark_low <span class="token operator">+=</span> zone<span class="token operator">-></span>watermark<span class="token punctuation">[</span>WMARK_LOW<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Estimate the amount of memory available for userspace allocations,
 * without causing swapping.
 *
 * Free memory cannot be taken below the low watermark, before the
 * system starts swapping.
 */</span>
available <span class="token operator">=</span> i<span class="token punctuation">.</span>freeram <span class="token operator">-</span> wmark_low<span class="token punctuation">;</span>

<span class="token comment">/*
 * Not all the page cache can be freed, otherwise the system will
 * start swapping. Assume at least half of the page cache, or the
 * low watermark worth of cache, needs to stay.
 */</span>
pagecache <span class="token operator">=</span> pages<span class="token punctuation">[</span>LRU_ACTIVE_FILE<span class="token punctuation">]</span> <span class="token operator">+</span> pages<span class="token punctuation">[</span>LRU_INACTIVE_FILE<span class="token punctuation">]</span><span class="token punctuation">;</span>
pagecache <span class="token operator">-=</span> <span class="token function">min</span><span class="token punctuation">(</span>pagecache <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> wmark_low<span class="token punctuation">)</span><span class="token punctuation">;</span>
available <span class="token operator">+=</span> pagecache<span class="token punctuation">;</span>

<span class="token comment">/*
 * Part of the reclaimable swap consists of items that are in use,
 * and cannot be freed. Cap this estimate at the low watermark.
 */</span>
available <span class="token operator">+=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_SLAB_RECLAIMABLE<span class="token punctuation">)</span> <span class="token operator">-</span>
	     <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_SLAB_RECLAIMABLE<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> wmark_low<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>available <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	available <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大体逻辑，把freeram，pagecache，RECLAIMABLE这些都算上，除了这些内存中有部分低水位不让用的，都算在available里了。</p>
<p>再看看free命令里是怎么模拟的，代码在<a target="_blank" rel="noopener" href="https://gitlab.com/procps-ng/procps/-/blob/v3.3.16/proc/sysinfo.c#L794">proc&#x2F;sysinfo.c</a>：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token comment">/* zero? might need fallback for 2.6.27 &lt;= kernel &lt;? 3.14 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kb_main_available<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__linux__</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>linux_version_code <span class="token operator">&lt;</span> <span class="token function">LINUX_VERSION</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      kb_main_available <span class="token operator">=</span> kb_main_free<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">FILE_TO_BUF</span><span class="token punctuation">(</span>VM_MIN_FREE_FILE<span class="token punctuation">,</span> vm_min_free_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      kb_min_free <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">strtoull</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token operator">&amp;</span>tail<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      watermark_low <span class="token operator">=</span> kb_min_free <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">/* should be equal to sum of all 'low' fields in /proc/zoneinfo */</span>

      mem_available <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">long</span><span class="token punctuation">)</span>kb_main_free <span class="token operator">-</span> watermark_low
      <span class="token operator">+</span> kb_inactive_file <span class="token operator">+</span> kb_active_file <span class="token operator">-</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token punctuation">(</span>kb_inactive_file <span class="token operator">+</span> kb_active_file<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> watermark_low<span class="token punctuation">)</span>
      <span class="token operator">+</span> kb_slab_reclaimable <span class="token operator">-</span> <span class="token function">MIN</span><span class="token punctuation">(</span>kb_slab_reclaimable <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> watermark_low<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_available <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> mem_available <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      kb_main_available <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>mem_available<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      kb_main_available <span class="token operator">=</span> kb_main_free<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* linux */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑差不多，多了一些判断内核版本的代码，也是找到最低水位，然后一堆加加减减。</p>
<p>最后需要注意的是，虽然是说这个MemAvailable是在3.14才被加到内核里的，但是由于红帽的backport，我们现在的CentOS7默认使用的3.10内核也是支持这个字段的。总体来说，针对标题的这个需求，参考free命令的算法，应该能比较好的跨平台和系统完成可用内存的估算工作。</p>

    </div>

    
    
    

    <footer class="post-footer"><div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/wechat-qrcode.jpg" alt="陈孚 wechat" style="width: 200px; max-width: 100%;">
  <div>新注册了公众号，同步更新，长按关注，可以第一时间收到推送</div>
</div>

          <div class="post-tags">
              <a href="/tags/meminfo/" rel="tag"># meminfo</a>
              <a href="/tags/SReclaimable/" rel="tag"># SReclaimable</a>
              <a href="/tags/available-memory/" rel="tag"># available memory</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/09/04/mount-cephfs-wrong-fs-type/" rel="prev" title="挂载CephFS出现wrong fs type的问题">
                  <i class="fa fa-angle-left"></i> 挂载CephFS出现wrong fs type的问题
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/10/consistent-network-device-naming/" rel="next" title="再谈网卡的一致性命名">
                  再谈网卡的一致性命名 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">陈孚</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://fastly.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"C0reFast/c0refast.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
